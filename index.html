<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>風向・風速モニター</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      text-align: center;
    }
    .section {
      margin-bottom: 40px;
    }
    svg {
      overflow: visible;
    }
    .icon {
      width: 50px;
      height: 50px;
    }
    .highlight {
      stroke: red;
      stroke-width: 3;
    }
  </style>
</head>
<body>
  <h1>風向・風速モニター（今日）</h1>
  <div id="display"></div>

  <script>
    const apiUrl = 'https://script.google.com/macros/s/AKfycbzZgiy79BuQtUgE1QVgdjaEpSD7knxwiLJsOdLADEmXk9eX2baUy9jwfsNomLXUKs6QbA/exec';

    function highlightDir(deg) {
      return (deg >= 22.5 && deg < 67.5); // NNE～ENE
    }

    function render(data) {
      const display = document.getElementById('display');
      display.innerHTML = '';

      const svgNS = "http://www.w3.org/2000/svg";
      const rows = [[], [], [], []]; // 午前1,2段、午後1,2段
      const now = new Date();
      data.forEach(entry => {
        const t = new Date(entry.timestamp);
        const hour = t.getHours();
        const minute = t.getMinutes();
        const timeStr = `${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`;
        const deg = entry.windDeg ?? 0;
        const speed = entry.windSpeed ?? 0;
        const iconCode = entry.iconCode ?? '';
        const description = entry.description ?? '';
        const humidity = entry.humidity ?? '–';

        const svg = document.createElementNS(svgNS, "svg");
        svg.setAttribute("width", "60");
        svg.setAttribute("height", "100");

        const g = document.createElementNS(svgNS, "g");
        g.setAttribute("transform", `translate(30,40) rotate(${(deg + 180) % 360})`);

        const shaft = document.createElementNS(svgNS, "line");
        shaft.setAttribute("x1", 0);
        shaft.setAttribute("y1", 0);
        shaft.setAttribute("x2", 0);
        shaft.setAttribute("y2", -Math.min(Math.max(speed * 4, 10), 30));
        shaft.setAttribute("stroke", "gray");
        shaft.setAttribute("stroke-width", "4");
        g.appendChild(shaft);

        const arrowHead = document.createElementNS(svgNS, "polygon");
        arrowHead.setAttribute("points", "-6,-40 6,-40 0,-30");
        arrowHead.setAttribute("fill", "gray");
        if (highlightDir(deg)) {
          arrowHead.setAttribute("fill", "red");
        }
        g.appendChild(arrowHead);
        svg.appendChild(g);

        const timeText = document.createElementNS(svgNS, "text");
        timeText.textContent = timeStr;
        timeText.setAttribute("x", 30);
        timeText.setAttribute("y", 90);
        timeText.setAttribute("text-anchor", "middle");
        timeText.setAttribute("font-size", "10");
        svg.appendChild(timeText);

        const icon = document.createElement("img");
        icon.className = "icon";
        icon.src = `https://openweathermap.org/img/wn/${iconCode}.png`;
        icon.alt = description;

        const container = document.createElement("div");
        container.className = "section";
        container.appendChild(svg);
        container.appendChild(icon);

        const rowIndex = (hour < 12)
          ? (hour < 6 ? 0 : 1)
          : (hour < 18 ? 2 : 3);
        rows[rowIndex].push(container);
      });

      const labels = ['午前（前半）', '午前（後半）', '午後（前半）', '午後（後半）'];
      rows.forEach((row, idx) => {
        if (row.length === 0) return;
        const section = document.createElement("div");
        section.className = "section";
        const label = document.createElement("h3");
        label.textContent = labels[idx];
        section.appendChild(label);
        const wrapper = document.createElement("div");
        wrapper.style.display = "flex";
        wrapper.style.flexWrap = "wrap";
        wrapper.style.justifyContent = "center";
        row.forEach(el => wrapper.appendChild(el));
        section.appendChild(wrapper);
        display.appendChild(section);
      });
    }

    fetch(apiUrl)
      .then(res => res.json())
      .then(render)
      .catch(err => {
        document.getElementById('display').textContent = "データ取得エラー：" + err;
      });
  </script>
</body>
</html>
