<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>風向・風速ビューア</title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
    }
    .date-title {
      font-size: 1.5em;
      margin: 1em 0;
    }
    .nav-links {
      margin-bottom: 1em;
    }
    .section-title {
      font-weight: bold;
      margin-top: 1em;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 4px;
      margin: 0.5em;
    }
    .entry {
      display: flex;
      flex-direction: column;
      align-items: center;
      font-size: 0.8em;
    }
    .icon {
      width: 32px;
      height: 32px;
    }
    svg {
      display: block;
    }
  </style>
</head>
<body>
  <div class="nav-links">
    <a id="prevDay" href="#">前日</a> ｜ <a id="nextDay" href="#">翌日</a>
  </div>
  <div class="date-title" id="dateTitle">Loading...</div>
  <div class="section-title">午前</div>
  <div class="grid" id="amRow1"></div>
  <div class="grid" id="amRow2"></div>
  <div class="section-title">午後</div>
  <div class="grid" id="pmRow1"></div>
  <div class="grid" id="pmRow2"></div>

  <!-- SVG filter -->
  <svg width="0" height="0">
    <defs>
      <filter id="glow" x="-50%" y="-50%" width="200%" height="200%">
        <feDropShadow dx="0" dy="0" stdDeviation="2" flood-color="orange"/>
      </filter>
    </defs>
  </svg>

  <script>
    const sheetURL = "https://script.google.com/macros/s/AKfycbzZgiy79BuQtUgE1QVgdjaEpSD7knxwiLJsOdLADEmXk9eX2baUy9jwfsNomLXUKs6QbA/exec";

    function padZero(n) {
      return n.toString().padStart(2, '0');
    }

    function getColorForSpeed(speed) {
      if (speed < 1) return "#99ccff";
      if (speed < 3) return "#66ccff";
      if (speed < 5) return "#00cccc";
      if (speed < 8) return "#ff9933";
      return "#ff3333";
    }

    function highlightDirection(deg) {
      return deg >= 22.5 && deg <= 67.5; // NNE〜ENE
    }

    function createArrowSVG(deg, speed, highlight) {
      const NS = "http://www.w3.org/2000/svg";
      const svg = document.createElementNS(NS, "svg");
      svg.setAttribute("width", "40");
      svg.setAttribute("height", "40");
      svg.setAttribute("viewBox", "0 0 40 40");

      const g = document.createElementNS(NS, "g");
      g.setAttribute("transform", `rotate(${(deg + 180) % 360}, 20, 20)`);

      const color = getColorForSpeed(speed);

      const shaft = document.createElementNS(NS, "line");
      shaft.setAttribute("x1", "20");
      shaft.setAttribute("y1", "25");
      shaft.setAttribute("x2", "20");
      shaft.setAttribute("y2", "15");
      shaft.setAttribute("stroke", color);
      shaft.setAttribute("stroke-width", "2");

      const head = document.createElementNS(NS, "polygon");
      head.setAttribute("points", "15,15 25,15 20,5");
      head.setAttribute("fill", highlight ? "red" : color);
      if (highlight) head.setAttribute("filter", "url(#glow)");

      g.appendChild(shaft);
      g.appendChild(head);
      svg.appendChild(g);
      return svg;
    }

    function getDateParam(offset = 0) {
      const url = new URL(location.href);
      const base = url.searchParams.get("date")
        ? new Date(url.searchParams.get("date"))
        : new Date();
      base.setDate(base.getDate() + offset);
      return `${base.getFullYear()}-${padZero(base.getMonth() + 1)}-${padZero(base.getDate())}`;
    }

    async function loadData() {
      const today = getDateParam();
      document.getElementById("dateTitle").textContent = `${today} の風向・風速`;
      document.getElementById("prevDay").href = `?date=${getDateParam(-1)}`;
      document.getElementById("nextDay").href = `?date=${getDateParam(1)}`;

      const res = await fetch(sheetURL);
      const raw = await res.json();

      const todayData = raw.filter(entry => {
        const d = new Date(entry.timestamp);
        return d.toISOString().slice(0, 10) === today;
      });

      const am = todayData.filter(e => new Date(e.timestamp).getHours() < 12);
      const pm = todayData.filter(e => new Date(e.timestamp).getHours() >= 12);

      function renderBlocks(data, row1, row2) {
        [row1, row2].forEach(r => r.innerHTML = '');
        data.forEach((e, i) => {
          const hour = new Date(e.timestamp).getHours();
          const min = new Date(e.timestamp).getMinutes();
          const timeStr = `${padZero(hour)}:${padZero(min)}`;

          const div = document.createElement("div");
          div.className = "entry";

          const time = document.createElement("div");
          time.textContent = timeStr;

          const svg = createArrowSVG(Number(e.windDeg), Number(e.windSpeed), highlightDirection(Number(e.windDeg)));

          const icon = document.createElement("img");
          icon.className = "icon";
          icon.src = `https://openweathermap.org/img/wn/${e.icon}@2x.png`;
          icon.alt = e.description;

          div.appendChild(time);
          div.appendChild(svg);
          div.appendChild(icon);

          if (i < 12) row1.appendChild(div);
          else row2.appendChild(div);
        });
      }

      renderBlocks(am, document.getElementById("amRow1"), document.getElementById("amRow2"));
      renderBlocks(pm, document.getElementById("pmRow1"), document.getElementById("pmRow2"));
    }

    loadData();
  </script>
</body>
</html>
