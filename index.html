<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>風向タイムライン</title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      padding: 20px;
    }
    .timeline-block {
      margin-bottom: 40px;
    }
    .timeline {
      display: grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 10px;
      justify-items: center;
    }
    .entry {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .timestamp {
      font-size: 10px;
      margin-bottom: 4px;
    }
    .icon {
      width: 40px;
      height: 40px;
      margin-top: 4px;
    }
    svg.arrow {
      width: 20px;
      height: 40px;
    }
    .highlight {
      filter: drop-shadow(0 0 4px orange);
    }
    .nav {
      margin-bottom: 20px;
    }
    .nav a {
      margin: 0 20px;
      text-decoration: none;
      font-weight: bold;
      color: #0077cc;
    }
  </style>
</head>
<body>
  <div class="nav" id="nav"></div>
  <h2 id="title">風向タイムライン</h2>

  <div class="timeline-block">
    <h3>午前</h3>
    <div class="timeline" id="am1"></div>
    <div class="timeline" id="am2"></div>
  </div>

  <div class="timeline-block">
    <h3>午後</h3>
    <div class="timeline" id="pm1"></div>
    <div class="timeline" id="pm2"></div>
  </div>

  <script>
    const apiBase = 'https://script.google.com/macros/s/AKfycbzZgiy79BuQtUgE1QVgdjaEpSD7knxwiLJsOdLADEmXk9eX2baUy9jwfsNomLXUKs6QbA/exec';
    const urlParams = new URLSearchParams(window.location.search);
    const dateParam = urlParams.get("date");

    function formatDate(date) {
      return date.toISOString().split("T")[0].replace(/-/g, "/");
    }

    function getDateObj(str) {
      const [y, m, d] = str.split("/").map(Number);
      return new Date(y, m - 1, d);
    }

    function pad(num) {
      return num.toString().padStart(2, "0");
    }

    function highlightDir(deg) {
      // 北北東〜東北東
      return (deg >= 22.5 && deg <= 67.5);
    }

    function getColor(speed) {
      if (speed < 1) return "#a0c4ff";
      if (speed < 3) return "#5ca0ff";
      if (speed < 5) return "#ffa600";
      if (speed < 8) return "#ff6f00";
      return "#d00000";
    }

    function createArrowSVG(deg, speed, highlight) {
      const rotation = (deg + 180) % 360;
      const color = getColor(speed);
      const g = document.createElementNS("http://www.w3.org/2000/svg", "svg");
      g.setAttribute("class", `arrow ${highlight ? "highlight" : ""}`);
      g.setAttribute("viewBox", "0 0 40 40");
      g.innerHTML = `
        <g transform="rotate(${rotation}, 10, 20)">
          <line x1="20" y1="20" x2="20" y2="5" stroke="${color}" stroke-width="3" />
          <polygon points="5,5 15,5 10,0" fill="${color}" />
        </g>
      `;
      return g;
    }

    function createEntry(entry) {
      const t = new Date(entry.timestamp);
      const hour = t.getHours();
      const minute = t.getMinutes();
      const timeStr = `${pad(hour)}:${pad(minute)}`;
      const deg = entry.windDeg ?? 0;
      const speed = entry.windSpeed ?? 0;
      const iconCode = entry.icon ?? '';
      const desc = entry.description ?? '';

      const div = document.createElement("div");
      div.className = "entry";

      const timeDiv = document.createElement("div");
      timeDiv.className = "timestamp";
      timeDiv.textContent = timeStr;

      const arrow = createArrowSVG(deg, speed, highlightDir(deg));

      const icon = document.createElement("img");
      icon.className = "icon";
      icon.src = `https://openweathermap.org/img/wn/${iconCode}.png`;
      icon.alt = desc;

      div.appendChild(timeDiv);
      div.appendChild(arrow);
      div.appendChild(icon);
      return div;
    }

    function renderTimelines(data) {
      const am1 = document.getElementById("am1");
      const am2 = document.getElementById("am2");
      const pm1 = document.getElementById("pm1");
      const pm2 = document.getElementById("pm2");

      const am = data.filter(d => new Date(d.timestamp).getHours() < 12);
      const pm = data.filter(d => new Date(d.timestamp).getHours() >= 12);

      [am1, am2].forEach(e => e.innerHTML = "");
      [pm1, pm2].forEach(e => e.innerHTML = "");

      am.forEach((e, i) => {
        (i < 12 ? am1 : am2).appendChild(createEntry(e));
      });
      pm.forEach((e, i) => {
        (i < 12 ? pm1 : pm2).appendChild(createEntry(e));
      });
    }

    function setNavAndTitle(dateStr) {
      const dateObj = getDateObj(dateStr);
      const title = document.getElementById("title");
      title.textContent = `${dateStr} の風向タイムライン`;

      const nav = document.getElementById("nav");
      const prev = new Date(dateObj);
      prev.setDate(prev.getDate() - 1);
      const next = new Date(dateObj);
      next.setDate(next.getDate() + 1);
      nav.innerHTML = `
        <a href="?date=${formatDate(prev)}">← 前日</a>
        <a href="?date=${formatDate(next)}">翌日 →</a>
      `;
    }

    const today = new Date();
    const dateStr = dateParam || formatDate(today);
    setNavAndTitle(dateStr);

    fetch(`${apiBase}?date=${encodeURIComponent(dateStr)}`)
      .then(res => res.json())
      .then(data => {
        if (!Array.isArray(data) || data.length === 0) {
          document.body.innerHTML += "<p>データがありません。</p>";
        } else {
          renderTimelines(data);
        }
      })
      .catch(err => {
        console.error(err);
        document.body.innerHTML += "<p>データ取得エラー</p>";
      });
  </script>
</body>
</html>
