<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>風向タイムライン</title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 10px;
      margin: 20px;
    }
    .entry {
      display: flex;
      flex-direction: column;
      align-items: center;
      font-size: 10px;
    }
    svg {
      width: 30px;
      height: 60px;
    }
    .icon {
      width: 30px;
      height: 30px;
    }
  </style>
</head>
<body>
  <div id="nav"></div>
  <h2 id="title"></h2>
  <h3>午前</h3>
  <div class="grid" id="am1"></div>
  <div class="grid" id="am2"></div>
  <h3>午後</h3>
  <div class="grid" id="pm1"></div>
  <div class="grid" id="pm2"></div>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const date = urlParams.get('date') || new Date().toLocaleDateString('ja-JP', { year: 'numeric', month: '2-digit', day: '2-digit' }).replaceAll('/', '/');
    const apiUrl = `https://script.google.com/macros/s/xxxxxxxxxxxxxxxxxxxxxxxxxxx/exec?date=${date}`;

    const highlightDir = deg => deg >= 22.5 && deg <= 67.5;
    const getColor = speed => {
      if (speed < 1) return '#b3e5fc';
      if (speed < 3) return '#81d4fa';
      if (speed < 5) return '#4fc3f7';
      if (speed < 8) return '#29b6f6';
      return '#0288d1';
    };
    const padZero = num => num.toString().padStart(2, '0');

    const prevDate = new Date(date);
    prevDate.setDate(prevDate.getDate() - 1);
    const nextDate = new Date(date);
    nextDate.setDate(nextDate.getDate() + 1);

    document.getElementById('nav').innerHTML = `
      <a href="?date=${prevDate.toISOString().split('T')[0].replace(/-/g, '/')}">←前日</a>
      |
      <a href="?date=${nextDate.toISOString().split('T')[0].replace(/-/g, '/')}">翌日→</a>
    `;

    document.getElementById('title').textContent = `${date} の風向`;

    fetch(apiUrl)
      .then(res => res.json())
      .then(data => {
        const am1 = document.getElementById('am1');
        const am2 = document.getElementById('am2');
        const pm1 = document.getElementById('pm1');
        const pm2 = document.getElementById('pm2');

        let amCount = 0, pmCount = 0;

        data.forEach(entry => {
          const time = new Date(entry.timestamp);
          const h = time.getHours();
          const m = time.getMinutes();
          const timeStr = `${padZero(h)}:${padZero(m)}`;

          const deg = Number(entry.windDeg);
          const speed = Number(entry.windSpeed);
          const icon = entry.icon;
          const desc = entry.description;

          const arrowColor = highlightDir(deg) ? 'red' : getColor(speed);

          const svg = `<svg viewBox="0 0 10 40" xmlns="http://www.w3.org/2000/svg">
            <line x1="5" y1="0" x2="5" y2="25" stroke="${arrowColor}" stroke-width="2" transform="rotate(${(deg + 180) % 360}, 5, 20)" />
            <polygon points="0,25 10,25 5,40" fill="${arrowColor}" transform="rotate(${(deg + 180) % 360}, 5, 20)" />
          </svg>`;

          const div = document.createElement('div');
          div.className = 'entry';
          div.innerHTML = `
            <div>${timeStr}</div>
            ${svg}
            <img class="icon" src="https://openweathermap.org/img/wn/${icon}@2x.png" alt="${desc}">
          `;

          if (h < 12) {
            (amCount < 12 ? am1 : am2).appendChild(div);
            amCount++;
          } else {
            (pmCount < 12 ? pm1 : pm2).appendChild(div);
            pmCount++;
          }
        });
      });
  </script>
</body>
</html>
